<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>see AI - 全能智能助手</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3B82F6',
                        secondary: '#10B981',
                        dark: '#1F2937',
                        light: '#F3F4F6',
                        accent: '#8B5CF6',
                        danger: '#EF4444',
                        warning: '#F59E0B',
                        info: '#06B6D4'
                    },
                    fontFamily: {
                        inter: ['Inter', 'system-ui', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .scrollbar-hide {
                -ms-overflow-style: none;
                scrollbar-width: none;
            }
            .scrollbar-hide::-webkit-scrollbar {
                display: none;
            }
            .ai-avatar {
                width: 40px;
                height: 40px;
                border-radius: 50%;
                background-color: #000;
                display: flex;
                align-items: center;
                justify-content: center;
                color: white;
                font-weight: bold;
            }
            .feature-btn {
                @apply flex items-center gap-2 p-2 rounded-lg hover:bg-light transition-all duration-200;
            }
            .message-card {
                @apply rounded-2xl p-4 shadow-sm max-w-[85%] break-words;
            }
            .copyright {
                @apply text-xs text-gray-500 py-2 border-t border-gray-200 text-center;
            }
            .usage-counter {
                @apply text-xs text-gray-500 absolute top-1 right-4;
            }
            .call-btn {
                @apply w-12 h-12 rounded-full flex items-center justify-center text-white shadow-lg transition-transform hover:scale-105 active:scale-95;
            }
            .pulse-animation {
                animation: pulse 2s infinite;
            }
            @keyframes pulse {
                0% { transform: scale(1); opacity: 1; }
                50% { transform: scale(1.05); opacity: 0.8; }
                100% { transform: scale(1); opacity: 1; }
            }
        }
    </style>
</head>
<body class="font-inter bg-gray-50 text-dark h-screen flex flex-col overflow-hidden">
    <!-- 登录模态框 -->
    <div id="loginModal" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-xl p-6 w-full max-w-md relative">
            <button id="closeLoginBtn" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                <i class="fa fa-times"></i>
            </button>
            <h2 class="text-2xl font-bold mb-4 flex items-center gap-2">
                <div class="ai-avatar text-sm">S</div>
                <span>see AI 登录</span>
            </h2>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">邮箱</label>
                    <input type="email" id="loginEmail" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary" placeholder="your@email.com">
                    <p id="emailError" class="text-red-500 text-xs mt-1 hidden">请输入有效的邮箱地址</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">密码</label>
                    <input type="password" id="loginPassword" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary" placeholder="至少6位字符">
                    <p id="passwordError" class="text-red-500 text-xs mt-1 hidden">密码长度至少6位</p>
                </div>
                <div class="flex items-center gap-2">
                    <input type="checkbox" id="rememberMe" class="rounded text-primary">
                    <label for="rememberMe" class="text-sm text-gray-600">记住我</label>
                </div>
                <button id="loginBtn" class="w-full bg-primary text-white py-2 rounded-lg hover:bg-primary/90 transition-colors">登录</button>
                <p class="text-center text-sm text-gray-500">没有账号？<span class="text-primary cursor-pointer">注册</span></p>
            </div>
        </div>
    </div>

    <!-- 语音通话模态框 -->
    <div id="callModal" class="fixed inset-0 bg-black/80 z-50 flex flex-col items-center justify-center p-4 hidden">
        <div class="w-full max-w-md bg-white rounded-xl overflow-hidden">
            <div class="bg-primary text-white p-4 text-center">
                <h3 id="callStatus" class="text-lg font-medium">正在呼叫...</h3>
                <p id="callTarget" class="text-sm opacity-80 mt-1">AI语音助手</p>
            </div>
            <div class="p-6 flex flex-col items-center">
                <div class="w-24 h-24 rounded-full bg-gray-100 flex items-center justify-center mb-4 relative">
                    <div class="ai-avatar w-20 h-20">S</div>
                    <span class="absolute bottom-0 right-0 w-6 h-6 bg-green-500 rounded-full border-2 border-white pulse-animation"></span>
                </div>
                <div id="callTimer" class="text-gray-500 text-sm mb-6">00:00</div>
                <div class="flex justify-center gap-4">
                    <button id="shareScreenBtn" class="call-btn bg-info">
                        <i class="fa fa-desktop"></i>
                    </button>
                    <button id="muteCallBtn" class="call-btn bg-warning">
                        <i class="fa fa-microphone"></i>
                    </button>
                    <button id="endCallBtn" class="call-btn bg-danger">
                        <i class="fa fa-phone fa-rotate-135"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 音乐生成模态框 -->
    <div id="musicModal" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-xl p-6 w-full max-w-lg">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">生成音乐</h3>
                <button id="closeMusicModal" class="text-gray-400 hover:text-gray-600">
                    <i class="fa fa-times"></i>
                </button>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">音乐描述</label>
                    <input type="text" id="musicPrompt" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary" placeholder="例如：轻快的钢琴曲，适合雨天聆听">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">风格</label>
                    <select id="musicGenre" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary">
                        <option value="classical">古典</option>
                        <option value="pop">流行</option>
                        <option value="jazz">爵士</option>
                        <option value="electronic">电子</option>
                        <option value="piano">钢琴独奏</option>
                    </select>
                </div>
                <button id="generateMusicBtn" class="w-full bg-primary text-white py-2 rounded-lg hover:bg-primary/90 transition-colors">生成音乐</button>
                
                <div id="musicResult" class="hidden mt-4">
                    <h4 class="font-medium mb-2">生成结果</h4>
                    <div class="bg-light p-4 rounded-lg">
                        <div class="flex items-center gap-3">
                            <div class="w-12 h-12 bg-primary/20 rounded flex items-center justify-center">
                                <i class="fa fa-music text-primary text-xl"></i>
                            </div>
                            <div class="flex-1">
                                <p id="musicTitle" class="font-medium text-sm">轻快雨天钢琴曲</p>
                                <p id="musicInfo" class="text-xs text-gray-500">2分30秒 · 钢琴独奏</p>
                            </div>
                        </div>
                        <audio id="musicPlayer" controls class="w-full mt-3">
                            <source src="" type="audio/mpeg">
                            您的浏览器不支持音频播放
                        </audio>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 视频生成模态框 -->
    <div id="videoModal" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-xl p-6 w-full max-w-lg">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">生成视频</h3>
                <button id="closeVideoModal" class="text-gray-400 hover:text-gray-600">
                    <i class="fa fa-times"></i>
                </button>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">视频描述</label>
                    <textarea id="videoPrompt" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary" rows="3" placeholder="例如：夕阳下的海滩，海浪轻轻拍打岸边，远处有海鸥飞过"></textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">时长</label>
                    <select id="videoDuration" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary">
                        <option value="10">10秒</option>
                        <option value="30">30秒</option>
                        <option value="60">1分钟</option>
                        <option value="120">2分钟</option>
                    </select>
                </div>
                <button id="generateVideoBtn" class="w-full bg-primary text-white py-2 rounded-lg hover:bg-primary/90 transition-colors">生成视频</button>
                
                <div id="videoResult" class="hidden mt-4">
                    <h4 class="font-medium mb-2">生成结果</h4>
                    <div class="bg-light p-4 rounded-lg">
                        <video id="videoPlayer" controls class="w-full rounded" poster="https://picsum.photos/seed/video/800/450">
                            <source src="" type="video/mp4">
                            您的浏览器不支持视频播放
                         </video>
                        <p id="videoInfo" class="text-xs text-gray-500 mt-2">10秒 · 1080p · 夕阳海滩场景</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 数据分析模态框 -->
    <div id="dataAnalysisModal" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-xl p-6 w-full max-w-3xl max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">数据分析</h3>
                <button id="closeDataAnalysisModal" class="text-gray-400 hover:text-gray-600">
                    <i class="fa fa-times"></i>
                </button>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">上传数据文件 (CSV)</label>
                    <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-primary transition-colors cursor-pointer" id="dataDropArea">
                        <i class="fa fa-upload text-3xl text-gray-400 mb-2"></i>
                        <p class="text-gray-500">点击或拖拽CSV文件到此处</p>
                        <input type="file" id="dataFileInput" accept=".csv" class="hidden">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">分析类型</label>
                    <select id="analysisType" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary">
                        <option value="trend">趋势分析</option>
                        <option value="distribution">分布分析</option>
                        <option value="correlation">相关性分析</option>
                        <option value="comparison">对比分析</option>
                    </select>
                </div>
                <button id="analyzeDataBtn" class="w-full bg-primary text-white py-2 rounded-lg hover:bg-primary/90 transition-colors">开始分析</button>
                
                <div id="dataAnalysisResult" class="hidden mt-4">
                    <h4 class="font-medium mb-2">分析结果</h4>
                    <div class="bg-light p-4 rounded-lg">
                        <div class="h-64 mb-4">
                            <canvas id="analysisChart"></canvas>
                        </div>
                        <div id="analysisSummary" class="text-sm">
                            <p class="font-medium">分析总结：</p>
                            <p class="mt-1 text-gray-600">数据显示过去6个月呈现稳步增长趋势，其中3月和6月达到峰值，平均增长率为8.2%。建议重点关注Q3季度的波动情况。</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 主容器 -->
    <div class="flex flex-1 overflow-hidden">
        <!-- 左侧边栏 - 历史对话 -->
        <div id="historyPanel" class="w-64 bg-white border-r border-gray-200 flex flex-col hidden md:flex transition-all duration-300">
            <div class="p-4 border-b border-gray-200 flex items-center justify-between">
                <h2 class="font-bold text-lg">历史对话</h2>
                <button id="newChatBtn" class="p-2 rounded-full hover:bg-light" title="新对话">
                    <i class="fa fa-plus"></i>
                </button>
            </div>
            
            <div class="flex-1 overflow-y-auto scrollbar-hide p-2" id="historyList">
                <!-- 历史对话项 -->
                <div class="history-item p-3 rounded-lg hover:bg-light cursor-pointer active bg-light/50 border-l-2 border-primary">
                    <p class="text-sm font-medium truncate">新对话</p>
                    <p class="text-xs text-gray-500 truncate mt-1">刚刚</p>
                </div>
            </div>
            
            <div class="p-4 border-t border-gray-200">
                <button id="showLoginBtn" class="flex items-center gap-2 w-full p-2 rounded-lg hover:bg-light text-sm">
                    <i class="fa fa-user-circle-o"></i>
                    <span>登录账号</span>
                </button>
            </div>
        </div>

        <!-- 中间 - 聊天区域 -->
        <div class="flex-1 flex flex-col bg-gray-50 overflow-hidden">
            <!-- 顶部导航 -->
            <div class="bg-white border-b border-gray-200 p-4 flex items-center justify-between relative">
                <div class="flex items-center gap-3">
                    <button id="toggleHistoryBtn" class="md:hidden p-2 rounded-full hover:bg-light">
                        <i class="fa fa-bars"></i>
                    </button>
                    <div class="flex items-center gap-2">
                        <div class="ai-avatar">S</div>
                        <h1 class="font-bold">see AI</h1>
                    </div>
                </div>
                <div class="flex items-center gap-1">
                    <button id="voiceCallBtn" class="p-2 rounded-full hover:bg-light relative text-primary">
                        <i class="fa fa-phone"></i>
                    </button>
                    <button class="p-2 rounded-full hover:bg-light relative">
                        <i class="fa fa-bell-o"></i>
                        <span class="absolute top-1 right-1 w-2 h-2 bg-red-500 rounded-full"></span>
                    </button>
                    <button id="toggleSidePanelBtn" class="p-2 rounded-full hover:bg-light">
                        <i class="fa fa-sliders"></i>
                    </button>
                </div>
                <!-- 未登录用户使用次数提示 -->
                <span id="usageCount" class="usage-counter hidden">剩余使用次数：10</span>
            </div>

            <!-- 聊天内容区 -->
            <div id="chatContainer" class="flex-1 p-4 md:p-6 overflow-y-auto scrollbar-hide space-y-6">
                <!-- 欢迎消息 -->
                <div class="flex items-start gap-3">
                    <div class="ai-avatar flex-shrink-0"></div>
                    <div class="message-card bg-white">
                        <p>您好！我是 see AI 全能助手，可为您提供以下服务：</p>
                        <ul class="list-disc list-inside text-sm mt-2 ml-2 space-y-1">
                            <li>智能问答、解题答疑（数学/物理等学科）</li>
                            <li>语音通话、屏幕共享</li>
                            <li>音乐生成、视频制作</li>
                            <li>数据分析、图表生成</li>
                        </ul>
                        <p class="text-xs text-gray-500 mt-2">未登录用户可免费使用10次，登录后无限制</p>
                    </div>
                </div>
            </div>

            <!-- 功能工具栏 -->
            <div class="bg-white border-t border-gray-200 p-3">
                <div class="flex flex-wrap gap-1 mb-2">
                    <button class="feature-btn text-sm" data-feature="search">
                        <i class="fa fa-search text-primary"></i>
                        <span>智能搜索</span>
                    </button>
                    <button class="feature-btn text-sm" data-feature="solve">
                        <i class="fa fa-calculator text-primary"></i>
                        <span>解题答疑</span>
                    </button>
                    <button class="feature-btn text-sm" data-feature="image-upload">
                        <i class="fa fa-upload text-primary"></i>
                        <span>上传图片</span>
                    </button>
                    <button class="feature-btn text-sm" data-feature="image-generate">
                        <i class="fa fa-picture-o text-primary"></i>
                        <span>生成图片</span>
                    </button>
                    <button class="feature-btn text-sm" data-feature="video-generate">
                        <i class="fa fa-film text-primary"></i>
                        <span>生成视频</span>
                    </button>
                    <button class="feature-btn text-sm" data-feature="music-generate">
                        <i class="fa fa-music text-primary"></i>
                        <span>生成音乐</span>
                    </button>
                    <button class="feature-btn text-sm" data-feature="data-analysis">
                        <i class="fa fa-bar-chart text-primary"></i>
                        <span>数据分析</span>
                    </button>
                    <button class="feature-btn text-sm" data-feature="translate">
                        <i class="fa fa-language text-primary"></i>
                        <span>翻译</span>
                    </button>
                </div>

                <!-- 输入区域 -->
                <div class="relative">
                    <textarea 
                        id="messageInput" 
                        class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-primary focus:border-primary resize-none"
                        rows="3"
                        placeholder="输入您的问题或指令..."
                    ></textarea>
                    <div class="absolute right-2 bottom-2 flex items-center gap-1">
                        <button id="voiceInputBtn" class="p-2 rounded-full hover:bg-light text-gray-600">
                            <i class="fa fa-microphone"></i>
                        </button>
                        <button id="sendMessageBtn" class="bg-primary text-white p-2 rounded-full hover:bg-primary/90">
                            <i class="fa fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
                <p class="text-xs text-gray-500 mt-2 ml-4">按 Shift+Enter 换行，Enter 发送</p>
            </div>

            <!-- 版权信息 -->
            <div class="copyright">
                © 2025 see AI 智能助手 | 保留所有权利 | <a href="#" class="text-primary hover:underline">隐私政策</a>
            </div>
        </div>

        <!-- 右侧边栏 - 功能面板 -->
        <div id="sidePanel" class="w-72 bg-white border-l border-gray-200 flex flex-col hidden lg:flex transition-all duration-300">
            <div class="p-4 border-b border-gray-200">
                <h2 class="font-bold text-lg">功能面板</h2>
            </div>
            
            <!-- 选项卡 -->
            <div class="flex border-b border-gray-200">
                <button class="flex-1 py-2 text-sm font-medium text-primary border-b-2 border-primary">收藏</button>
                <button class="flex-1 py-2 text-sm font-medium text-gray-500 hover:text-gray-700">历史记录</button>
            </div>
            
            <div class="flex-1 overflow-y-auto scrollbar-hide p-4">
                <div id="favoritesSection">
                    <p class="text-sm text-gray-500 mb-3">您还没有收藏任何对话</p>
                    <div class="text-center py-6">
                        <i class="fa fa-star-o text-4xl text-gray-300 mb-2"></i>
                        <p class="text-sm text-gray-400">收藏重要对话以便日后查看</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 图片上传输入（隐藏） -->
    <input type="file" id="imageUploadInput" accept="image/*" class="hidden">

    <script>
        // DOM元素
        const loginModal = document.getElementById('loginModal');
        const showLoginBtn = document.getElementById('showLoginBtn');
        const loginBtn = document.getElementById('loginBtn');
        const closeLoginBtn = document.getElementById('closeLoginBtn');
        const loginEmail = document.getElementById('loginEmail');
        const loginPassword = document.getElementById('loginPassword');
        const rememberMe = document.getElementById('rememberMe');
        const emailError = document.getElementById('emailError');
        const passwordError = document.getElementById('passwordError');
        const historyPanel = document.getElementById('historyPanel');
        const toggleHistoryBtn = document.getElementById('toggleHistoryBtn');
        const sidePanel = document.getElementById('sidePanel');
        const toggleSidePanelBtn = document.getElementById('toggleSidePanelBtn');
        const chatContainer = document.getElementById('chatContainer');
        const messageInput = document.getElementById('messageInput');
        const sendMessageBtn = document.getElementById('sendMessageBtn');
        const newChatBtn = document.getElementById('newChatBtn');
        const imageUploadInput = document.getElementById('imageUploadInput');
        const historyList = document.getElementById('historyList');
        const usageCountEl = document.getElementById('usageCount');
        const voiceInputBtn = document.getElementById('voiceInputBtn');
        const voiceCallBtn = document.getElementById('voiceCallBtn');
        const callModal = document.getElementById('callModal');
        const callStatus = document.getElementById('callStatus');
        const callTimer = document.getElementById('callTimer');
        const endCallBtn = document.getElementById('endCallBtn');
        const muteCallBtn = document.getElementById('muteCallBtn');
        const shareScreenBtn = document.getElementById('shareScreenBtn');
        const musicModal = document.getElementById('musicModal');
        const closeMusicModal = document.getElementById('closeMusicModal');
        const musicPrompt = document.getElementById('musicPrompt');
        const musicGenre = document.getElementById('musicGenre');
        const generateMusicBtn = document.getElementById('generateMusicBtn');
        const musicResult = document.getElementById('musicResult');
        const videoModal = document.getElementById('videoModal');
        const closeVideoModal = document.getElementById('closeVideoModal');
        const videoPrompt = document.getElementById('videoPrompt');
        const videoDuration = document.getElementById('videoDuration');
        const generateVideoBtn = document.getElementById('generateVideoBtn');
        const videoResult = document.getElementById('videoResult');
        const dataAnalysisModal = document.getElementById('dataAnalysisModal');
        const closeDataAnalysisModal = document.getElementById('closeDataAnalysisModal');
        const dataDropArea = document.getElementById('dataDropArea');
        const dataFileInput = document.getElementById('dataFileInput');
        const analysisType = document.getElementById('analysisType');
        const analyzeDataBtn = document.getElementById('analyzeDataBtn');
        const dataAnalysisResult = document.getElementById('dataAnalysisResult');
        
        // 功能按钮
        const featureButtons = document.querySelectorAll('[data-feature]');
        
        // 应用状态
        let currentChatId = 'new-chat-' + Date.now();
        let chatHistory = {
            [currentChatId]: []
        };
        let favorites = [];
        let isThinking = false;
        let currentUser = null; // 当前登录用户
        let guestUsageCount = 10; // 未登录用户剩余使用次数
        let callInterval = null; // 通话计时器
        let callSeconds = 0; // 通话秒数
        let isMuted = false; // 是否静音
        let isSharingScreen = false; // 是否共享屏幕
        
        // 敏感词库（优化版）
        const sensitiveWords = [
            // 骂人词汇
            '垃圾', '蠢货', '笨蛋', '混蛋', '傻X', '妈的', '操', '神经病', '去死',
            // 隐私相关词汇
            '身份证', '银行卡', '密码', '手机号', '住址', '行踪', '隐私', '征信', '社保号'
        ];
        
        // 权威知识库（优化版）
        const knowledgeBase = {
            科学: {
                物理: "物理学是研究物质最一般的运动规律和物质基本结构的学科，包括经典力学、相对论、量子力学等分支。经典力学由牛顿建立，描述宏观物体的运动；相对论由爱因斯坦提出，修正了高速运动和强引力场下的物理规律；量子力学则解释微观粒子的行为。",
                化学: "化学是在原子、分子水平上研究物质的组成、结构、性质及其变化规律的自然科学。主要分支包括有机化学（研究碳化合物）、无机化学（研究非碳化合物）、物理化学（研究化学现象的物理原理）等。元素周期表是化学的重要基础，由门捷列夫首次系统提出。",
                生物: "生物学是研究生命现象和生命活动规律的科学，涵盖分子生物学、细胞生物学、生态学等领域。细胞是生命的基本单位，DNA是主要遗传物质，进化论解释了生物的多样性和适应性。现代生物技术包括基因编辑（如CRISPR技术）、克隆等，具有广泛应用前景。"
            },
            技术: {
                人工智能: "人工智能（AI）是研究、开发用于模拟、延伸和扩展人的智能的理论、方法、技术及应用系统的一门新的技术科学。主要分支包括机器学习（让机器从数据中学习）、自然语言处理（让机器理解人类语言）、计算机视觉（让机器“看见”世界）等。GPT系列模型是自然语言处理领域的重要突破。",
                编程: "编程是使用编程语言编写计算机程序的过程，常见的编程语言包括Python（简洁易学，适合数据分析）、JavaScript（网页交互开发）、Java（跨平台应用开发）等。编程的核心是算法（解决问题的步骤）和数据结构（数据的组织方式），良好的代码需要具备可读性、可维护性和高效性。",
                区块链: "区块链是一种分布式账本技术，具有去中心化、不可篡改、全程留痕等特点，最初用于比特币底层技术。其核心是由区块组成的链式结构，每个区块包含交易信息和前一区块的哈希值，通过密码学保证安全性。除了数字货币，区块链还可应用于供应链管理、版权保护等领域。"
            },
            生活: {
                健康: "保持健康需要均衡饮食、规律作息和适度运动。建议每天摄入多种蔬菜水果（保证维生素和矿物质）、适量蛋白质（如瘦肉、豆类）和全谷物（提供膳食纤维）；成年人每天需7-8小时睡眠，避免熬夜；每周至少150分钟中等强度有氧运动（如快走、游泳），结合力量训练。",
                美食: "不同地区有不同的美食文化，中国八大菜系包括川菜（以麻辣著称，如麻婆豆腐）、粤菜（注重食材原味，如烧鹅）、鲁菜（宫廷菜代表，如葱烧海参）、苏菜（精致细腻，如松鼠鳜鱼）、闽菜（擅用海鲜，如佛跳墙）、浙菜（清淡鲜嫩，如西湖醋鱼）、湘菜（香辣，如剁椒鱼头）、徽菜（重油重色，如臭鳜鱼）。",
                旅行: "旅行可以开阔视野、放松心情。规划旅行时需考虑目的地气候（提前查看天气预报）、景点开放时间（部分景点需预约）和当地文化习俗（尊重当地禁忌）。安全提示：提前购买旅游保险，保管好个人财物，记录紧急联系方式。"
            },
            历史: {
                中国: "中国是世界上历史最悠久的国家之一，拥有5000多年文明史。主要朝代包括：夏商周（早期国家形态）、秦汉（统一多民族国家形成）、隋唐（封建社会鼎盛时期）、宋元（商品经济发展）、明清（君主专制强化）。1949年中华人民共和国成立，开启了中国历史新纪元。",
                世界: "世界历史涵盖了各大文明的起源与发展，包括古埃及（尼罗河文明，金字塔为象征）、古希腊（民主制度起源，哲学发达）、古罗马（法律体系影响深远）、中世纪欧洲（基督教文化主导）、大航海时代（地理大发现，世界联系加强）、工业革命（生产力飞跃，社会结构变革）等重要阶段。"
            }
        };
        
        // 解题库（数学/物理示例）
        const problemSolutions = {
            数学: {
                "一元二次方程": {
                    example: "求解方程：x² + 3x - 4 = 0",
                    solution: `
                        <p>解题步骤：</p>
                        <ol class="list-decimal list-inside ml-2 space-y-1 mt-1">
                            <li>确定系数：a=1，b=3，c=-4</li>
                            <li>计算判别式：Δ = b² - 4ac = 3² - 4×1×(-4) = 9 + 16 = 25</li>
                            <li>判别式Δ>0，有两个不同实根</li>
                            <li>代入求根公式：x = [-b ± √Δ]/(2a)</li>
                            <li>x₁ = [-3 + 5]/2 = 1，x₂ = [-3 - 5]/2 = -4</li>
                        </ol>
                        <p class="mt-2">答案：x₁=1，x₂=-4</p>
                    `
                },
                "勾股定理": {
                    example: "直角三角形直角边为3和4，求斜边长度",
                    solution: `
                        <p>解题步骤：</p>
                        <ol class="list-decimal list-inside ml-2 space-y-1 mt-1">
                            <li>勾股定理公式：a² + b² = c²（c为斜边）</li>
                            <li>代入数值：3² + 4² = c² → 9 + 16 = c² → 25 = c²</li>
                            <li>开平方：c = √25 = 5</li>
                        </ol>
                        <p class="mt-2">答案：斜边长度为5</p>
                    `
                }
            },
            物理: {
                "速度计算": {
                    example: "物体在10秒内移动了50米，求平均速度",
                    solution: `
                        <p>解题步骤：</p>
                        <ol class="list-decimal list-inside ml-2 space-y-1 mt-1">
                            <li>速度公式：v = s/t（v为速度，s为路程，t为时间）</li>
                            <li>代入数值：v = 50m / 10s = 5m/s</li>
                        </ol>
                        <p class="mt-2">答案：平均速度为5米/秒</p>
                    `
                },
                "浮力计算": {
                    example: "体积为0.01m³的物体完全浸入水中，求受到的浮力（ρ水=1000kg/m³，g=10N/kg）",
                    solution: `
                        <p>解题步骤：</p>
                        <ol class="list-decimal list-inside ml-2 space-y-1 mt-1">
                            <li>浮力公式：F浮 = ρ液gV排</li>
                            <li>物体完全浸入，V排 = V物 = 0.01m³</li>
                            <li>代入数值：F浮 = 1000kg/m³ × 10N/kg × 0.01m³ = 100N</li>
                        </ol>
                        <p class="mt-2">答案：受到的浮力为100牛</p>
                    `
                }
            }
        };
        
        // 翻译词典（扩展版）
        const translationDict = {
            "你好": "Hello",
            "谢谢": "Thank you",
            "再见": "Goodbye",
            "我爱你": "I love you",
            "今天天气很好": "The weather is nice today",
            "我想吃苹果": "I want to eat an apple",
            "请帮我翻译": "Please help me translate",
            "人工智能很有趣": "Artificial intelligence is very interesting"
        };

        // 初始化
        function init() {
            // 从本地存储加载数据
            loadFromLocalStorage();
            checkLoginStatus(); // 检查登录状态
            updateUsageCount(); // 更新使用次数显示
            
            // 事件监听
            bindEvents();
        }
        
        // 绑定事件
        function bindEvents() {
            // 登录相关
            showLoginBtn.addEventListener('click', () => loginModal.classList.remove('hidden'));
            closeLoginBtn.addEventListener('click', () => loginModal.classList.add('hidden'));
            loginBtn.addEventListener('click', validateLogin);
            loginModal.addEventListener('click', (e) => {
                if (e.target === loginModal) loginModal.classList.add('hidden');
            });
            
            // 输入验证
            loginEmail.addEventListener('input', () => {
                if (emailError.classList.contains('hidden') === false) {
                    validateEmail();
                }
            });
            loginPassword.addEventListener('input', () => {
                if (passwordError.classList.contains('hidden') === false) {
                    validatePassword();
                }
            });
            
            // 面板切换
            toggleHistoryBtn.addEventListener('click', () => {
                historyPanel.classList.toggle('hidden');
                historyPanel.classList.toggle('flex');
            });
            toggleSidePanelBtn.addEventListener('click', () => {
                sidePanel.classList.toggle('hidden');
                sidePanel.classList.toggle('flex');
            });
            
            // 发送消息
            sendMessageBtn.addEventListener('click', sendMessage);
            messageInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            
            // 新对话
            newChatBtn.addEventListener('click', createNewChat);
            
            // 功能按钮
            featureButtons.forEach(btn => {
                btn.addEventListener('click', () => handleFeature(btn.dataset.feature));
            });

            // 语音输入按钮
            voiceInputBtn.addEventListener('click', () => {
                if (!canUseFeature()) {
                    showNotification('使用次数不足，请登录后继续');
                    loginModal.classList.remove('hidden');
                    return;
                }
                showNotification('正在聆听...');
                // 模拟语音识别
                setTimeout(() => {
                    const voiceText = "这是一段语音输入的示例文本，您可以直接编辑或发送。";
                    messageInput.value = voiceText;
                    showNotification('语音识别完成');
                }, 2000);
            });

            // 语音通话相关
            voiceCallBtn.addEventListener('click', startVoiceCall);
            endCallBtn.addEventListener('click', endVoiceCall);
            muteCallBtn.addEventListener('click', toggleMute);
            shareScreenBtn.addEventListener('click', toggleScreenShare);

            // 音乐生成相关
            document.querySelector('[data-feature="music-generate"]').addEventListener('click', () => {
                if (!canUseFeature()) {
                    showNotification('使用次数不足，请登录后继续');
                    loginModal.classList.remove('hidden');
                    return;
                }
                musicModal.classList.remove('hidden');
            });
            closeMusicModal.addEventListener('click', () => musicModal.classList.add('hidden'));
            generateMusicBtn.addEventListener('click', generateMusic);

            // 视频生成相关
            document.querySelector('[data-feature="video-generate"]').addEventListener('click', () => {
                if (!canUseFeature()) {
                    showNotification('使用次数不足，请登录后继续');
                    loginModal.classList.remove('hidden');
                    return;
                }
                videoModal.classList.remove('hidden');
            });
            closeVideoModal.addEventListener('click', () => videoModal.classList.add('hidden'));
            generateVideoBtn.addEventListener('click', generateVideo);

            // 数据分析相关
            document.querySelector('[data-feature="data-analysis"]').addEventListener('click', () => {
                if (!canUseFeature()) {
                    showNotification('使用次数不足，请登录后继续');
                    loginModal.classList.remove('hidden');
                    return;
                }
                dataAnalysisModal.classList.remove('hidden');
            });
            closeDataAnalysisModal.addEventListener('click', () => dataAnalysisModal.classList.add('hidden'));
            dataDropArea.addEventListener('click', () => dataFileInput.click());
            dataFileInput.addEventListener('change', handleDataFileUpload);
            dataDropArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                dataDropArea.classList.add('border-primary');
            });
            dataDropArea.addEventListener('dragleave', () => {
                dataDropArea.classList.remove('border-primary');
            });
            dataDropArea.addEventListener('drop', (e) => {
                e.preventDefault();
                dataDropArea.classList.remove('border-primary');
                if (e.dataTransfer.files.length) {
                    dataFileInput.files = e.dataTransfer.files;
                    handleDataFileUpload();
                }
            });
            analyzeDataBtn.addEventListener('click', analyzeData);
        }
        
        // 验证登录表单
        function validateLogin() {
            const isEmailValid = validateEmail();
            const isPasswordValid = validatePassword();
            
            if (isEmailValid && isPasswordValid) {
                // 模拟登录成功
                const user = {
                    email: loginEmail.value,
                    name: loginEmail.value.split('@')[0] // 用邮箱前缀作为用户名
                };
                
                // 保存登录状态
                currentUser = user;
                if (rememberMe.checked) {
                    localStorage.setItem('seeAiUser', JSON.stringify(user));
                } else {
                    sessionStorage.setItem('seeAiUser', JSON.stringify(user));
                }
                
                // 更新界面：登录后无使用限制
                updateLoginUI();
                loginModal.classList.add('hidden');
                usageCountEl.classList.add('hidden');
                showNotification(`欢迎回来，${user.name}！登录后无使用次数限制`);
                
                // 清空表单
                loginEmail.value = '';
                loginPassword.value = '';
            }
        }
        
        // 验证邮箱
        function validateEmail() {
            const email = loginEmail.value.trim();
            const regex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            
            if (!regex.test(email)) {
                emailError.classList.remove('hidden');
                return false;
            } else {
                emailError.classList.add('hidden');
                return true;
            }
        }
        
        // 验证密码
        function validatePassword() {
            const password = loginPassword.value;
            
            if (password.length < 6) {
                passwordError.classList.remove('hidden');
                return false;
            } else {
                passwordError.classList.add('hidden');
                return true;
            }
        }
        
        // 检查登录状态
        function checkLoginStatus() {
            const savedUser = localStorage.getItem('seeAiUser') || sessionStorage.getItem('seeAiUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                updateLoginUI();
            } else {
                // 未登录用户加载使用次数
                const savedCount = localStorage.getItem('seeAiGuestUsage');
                if (savedCount) {
                    guestUsageCount = parseInt(savedCount);
                }
            }
        }
        
        // 更新登录状态UI
        function updateLoginUI() {
            if (currentUser) {
                showLoginBtn.innerHTML = `
                    <i class="fa fa-user-circle"></i>
                    <span>${currentUser.name}</span>
                `;
                // 登录后可添加退出登录选项
                showLoginBtn.addEventListener('click', () => {
                    if (confirm('确定要退出登录吗？')) {
                        logout();
                    }
                }, { once: true });
            }
        }
        
        // 退出登录
        function logout() {
            currentUser = null;
            localStorage.removeItem('seeAiUser');
            sessionStorage.removeItem('seeAiUser');
            showLoginBtn.innerHTML = '<i class="fa fa-user-circle-o"></i><span>登录账号</span>';
            showNotification('已退出登录，将恢复使用次数限制');
            // 重新初始化未登录状态
            guestUsageCount = localStorage.getItem('seeAiGuestUsage') ? parseInt(localStorage.getItem('seeAiGuestUsage')) : 10;
            updateUsageCount();
            bindEvents(); // 重新绑定登录按钮事件
        }
        
        // 更新使用次数显示
        function updateUsageCount() {
            if (!currentUser) {
                usageCountEl.textContent = `剩余使用次数：${guestUsageCount}`;
                usageCountEl.classList.remove('hidden');
                // 保存到本地存储
                localStorage.setItem('seeAiGuestUsage', guestUsageCount);
            }
        }
        
        // 检查是否可以继续使用（未登录用户）
        function canUseFeature() {
            if (currentUser) return true;
            return guestUsageCount > 0;
        }
        
        // 减少使用次数
        function decreaseUsageCount() {
            if (!currentUser) {
                guestUsageCount--;
                updateUsageCount();
                // 次数用尽时提示登录
                if (guestUsageCount <= 0) {
                    showNotification('您的免费使用次数已用尽，请登录后继续使用');
                    loginModal.classList.remove('hidden');
                    sendMessageBtn.disabled = true;
                    sendMessageBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
                    sendMessageBtn.classList.remove('bg-primary', 'hover:bg-primary/90');
                }
            }
        }
        
        // 检查敏感词
        function hasSensitiveWords(text) {
            const lowerText = text.toLowerCase();
            return sensitiveWords.some(word => lowerText.includes(word.toLowerCase()));
        }
        
        // 处理功能按钮点击
        function handleFeature(feature) {
            if (!canUseFeature()) {
                showNotification('使用次数不足，请登录后继续');
                loginModal.classList.remove('hidden');
                return;
            }
            
            switch(feature) {
                case 'search':
                    messageInput.value = '智能搜索：';
                    messageInput.focus();
                    break;
                case 'solve':
                    messageInput.value = '解题：';
                    messageInput.focus();
                    break;
                case 'image-upload':
                    imageUploadInput.click();
                    imageUploadInput.onchange = handleImageUpload;
                    break;
                case 'image-generate':
                    messageInput.value = '生成图片：';
                    messageInput.focus();
                    break;
                case 'translate':
                    messageInput.value = '翻译：';
                    messageInput.focus();
                    break;
            }
        }
        
        // 处理图片上传
        function handleImageUpload(e) {
            if (!canUseFeature()) {
                showNotification('使用次数不足，请登录后继续');
                loginModal.classList.remove('hidden');
                imageUploadInput.value = '';
                return;
            }
            
            const file = e.target.files[0];
            if (!file) return;
            
            // 检查是否为图片
            if (!file.type.startsWith('image/')) {
                showNotification('请上传图片文件');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = (event) => {
                const imageUrl = event.target.result;
                addMessageToChat('user', { type: 'image', content: imageUrl });
                decreaseUsageCount(); // 消耗一次使用次数
                
                // 模拟AI处理图片
                setTimeout(() => {
                    addMessageToChat('ai', { 
                        type: 'text', 
                        content: '已收到您上传的图片。这张图片看起来是一张照片（实际应用中会进行图片识别和分析）。需要我对这张图片做些什么吗？比如描述内容、提取文字或生成相关图片？' 
                    });
                }, 1500);
            };
            reader.readAsDataURL(file);
            imageUploadInput.value = '';
        }
        
        // 发送消息
        function sendMessage() {
            if (!canUseFeature()) {
                showNotification('使用次数不足，请登录后继续');
                loginModal.classList.remove('hidden');
                return;
            }
            
            const content = messageInput.value.trim();
            if (!content) return;
            
            // 检查敏感词
            if (hasSensitiveWords(content)) {
                addMessageToChat('ai', { 
                    type: 'text', 
                    content: '您的输入包含不适当内容，我无法为您提供相关帮助。请使用文明用语并遵守相关规定。' 
                });
                messageInput.value = '';
                return;
            }
            
            // 添加用户消息
            addMessageToChat('user', { type: 'text', content });
            decreaseUsageCount(); // 消耗一次使用次数
            
            // 清空输入框
            messageInput.value = '';
            
            // 根据消息内容判断处理类型
            handleMessageProcessing(content);
        }
        
        // 模拟网络搜索（返回结构化结果）
        function simulateWebSearch(query) {
            // 模拟搜索结果（实际应用中可替换为真实API调用）
            return {
                query: query,
                results: [
                    {
                        title: `关于${query}的权威解释`,
                        source: "维基百科",
                        snippet: `维基百科对${query}的解释：${query}是一个重要概念，涉及多个领域，其核心定义为...`,
                        url: "https://example.com/wiki"
                    },
                    {
                        title: `${query}最新研究进展`,
                        source: "科学期刊网",
                        snippet: `2024年最新研究显示，${query}在实际应用中取得了突破，研究团队发现...`,
                        url: "https://example.com/research"
                    },
                    {
                        title: `${query}常见问题解答`,
                        source: "行业官方网站",
                        snippet: `针对用户关心的${query}问题，官方解答如下：1. ... 2. ...`,
                        url: "https://example.com/faq"
                    }
                ]
            };
        }
        
        // 处理消息并生成响应（智能回答核心逻辑）
        function handleMessageProcessing(content) {
            // 显示思考过程
            showThinkingProcess(content);
            
            // 根据内容类型生成不同响应
            setTimeout(() => {
                isThinking = false;
                
                if (content.startsWith('智能搜索：')) {
                    const query = content.replace('智能搜索：', '').trim();
                    generateSearchResponse(query);
                } else if (content.startsWith('生成图片：')) {
                    const prompt = content.replace('生成图片：', '').trim();
                    generateImageResponse(prompt);
                } else if (content.startsWith('翻译：')) {
                    const text = content.replace('翻译：', '').trim();
                    generateTranslationResponse(text);
                } else if (content.startsWith('解题：')) {
                    const problem = content.replace('解题：', '').trim();
                    generateSolutionResponse(problem);
                } else {
                    generateIntelligentResponse(content); // 智能回答
                }
            }, 2000 + Math.random() * 1500); // 随机延迟模拟思考时间
        }
        
        // 显示思考过程
        function showThinkingProcess(content) {
            isThinking = true;
            const thinkingHtml = `
                <div class="flex items-start gap-3" id="thinkingIndicator">
                    <div class="ai-avatar flex-shrink-0"></div>
                    <div class="message-card bg-white">
                        <div class="flex flex-col gap-2">
                            <p class="text-sm text-gray-500">正在思考：${content.substring(0, 30)}${content.length > 30 ? '...' : ''}</p>
                            <div class="flex space-x-1">
                                <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce"></div>
                                <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                                <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.4s"></div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            chatContainer.insertAdjacentHTML('beforeend', thinkingHtml);
            scrollToBottom();
        }
        
        // 生成智能搜索响应（结合网络搜索+知识库）
        function generateSearchResponse(query) {
            removeThinkingIndicator();
            // 1. 先查询网络搜索结果
            const webResults = simulateWebSearch(query);
            
            // 2. 再匹配知识库
            let relatedKnowledge = [];
            for (const [category, subCategories] of Object.entries(knowledgeBase)) {
                for (const [topic, content] of Object.entries(subCategories)) {
                    if (query.includes(topic) || topic.includes(query) || query.includes(category)) {
                        relatedKnowledge.push({ topic: `${category} - ${topic}`, content });
                    }
                }
            }
            
            // 3. 构建响应内容
            let webResultsHtml = '<div class="mt-2 space-y-3">';
            webResults.results.forEach((result, index) => {
                webResultsHtml += `
                    <div class="p-3 bg-light rounded-lg">
                        <h4 class="font-medium text-primary hover:underline cursor-pointer">${result.title}</h4>
                        <p class="text-xs text-gray-500 mt-1">来源：${result.source}</p>
                        <p class="text-sm text-gray-600 mt-1">${result.snippet}</p>
                        <a href="${result.url}" target="_blank" class="text-xs text-primary mt-1 inline-block">查看详情 →</a>
                    </div>
                `;
            });
            webResultsHtml += '</div>';
            
            let knowledgeHtml = '';
            if (relatedKnowledge.length > 0) {
                knowledgeHtml = `
                    <div class="mt-4">
                        <p class="font-medium">知识库补充信息：</p>
                        <div class="mt-2 space-y-2">
                            ${relatedKnowledge.map(item => `
                                <div class="p-2 bg-gray-50 rounded-lg">
                                    <p class="text-sm font-medium">${item.topic}</p>
                                    <p class="text-sm text-gray-600 mt-1">${item.content.substring(0, 120)}${item.content.length > 120 ? '...' : ''}</p>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            const response = `
                <p>关于“${query}”的综合搜索结果：</p>
                ${webResultsHtml}
                ${knowledgeHtml}
                <p class="mt-3 text-sm text-gray-500">需要我深入分析某条结果或扩展相关内容吗？</p>
            `;
            addMessageToChat('ai', { type: 'text', content: response });
        }
        
        // 生成图片响应
        function generateImageResponse(prompt) {
            removeThinkingIndicator();
            // 使用随机图片作为示例
            const randomImageId = Math.floor(Math.random() * 1000);
            const response = `
                <p>根据您的描述“${prompt}”生成的图片：</p>
                <div class="mt-2 rounded-lg overflow-hidden border border-gray-200">
                    <img src="https://picsum.photos/seed/${randomImageId}/600/400" alt="生成的图片" class="w-full h-auto">
                </div>
                <p class="mt-2 text-sm text-gray-500">如果不满意，可以提供更详细的描述，我会重新生成。</p>
            `;
            addMessageToChat('ai', { type: 'text', content: response });
        }
        
        // 生成翻译响应
        function generateTranslationResponse(text) {
            removeThinkingIndicator();
            // 检查是否有匹配的翻译
            let translatedText = translationDict[text];
            
            if (!translatedText) {
                // 无匹配时模拟调用翻译API
                translatedText = `[AI翻译] ${text.split('').reverse().join('')}`; // 仅作示例
            }
            
            const response = `
                <p>翻译结果：</p>
                <div class="mt-2 p-3 bg-light rounded-lg">
                    <p class="text-sm text-gray-500">原文：${text}</p>
                    <p class="mt-1 font-medium">译文：${translatedText}</p>
                </div>
                <div class="mt-2 flex gap-2">
                    <button class="text-xs px-2 py-1 bg-light rounded hover:bg-gray-200">中 → 英</button>
                    <button class="text-xs px-2 py-1 bg-light rounded hover:bg-gray-200">中 → 日</button>
                    <button class="text-xs px-2 py-1 bg-light rounded hover:bg-gray-200">中 → 韩</button>
                </div>
            `;
            addMessageToChat('ai', { type: 'text', content: response });
        }
        
        // 生成解题答疑响应
        function generateSolutionResponse(problem) {
            removeThinkingIndicator();
            // 尝试匹配解题库
            let matchedSolution = null;
            let matchedSubject = '';
            let matchedTopic = '';
            
            outerLoop:
            for (const [subject, topics] of Object.entries(problemSolutions)) {
                for (const [topic, details] of Object.entries(topics)) {
                    if (problem.includes(topic) || topic.includes(problem) || 
                        problem.includes(details.example)) {
                        matchedSolution = details.solution;
                        matchedSubject = subject;
                        matchedTopic = topic;
                        break outerLoop;
                    }
                }
            }
            
            if (matchedSolution) {
                // 有匹配的解题步骤
                const response = `
                    <p>关于${matchedSubject}的“${matchedTopic}”问题解答：</p>
                    ${matchedSolution}
                    <p class="mt-3 text-sm text-gray-500">需要解决其他类型的题目吗？可以直接输入具体问题。</p>
                `;
                addMessageToChat('ai', { type: 'text', content: response });
            } else {
                // 无匹配时提示
                const response = `
                    <p>未能识别您的题目，请提供更具体的问题，例如：</p>
                    <ul class="list-disc list-inside text-sm text-gray-600 mt-2 ml-2 space-y-1">
                        <li>数学：求解方程 x² + 5x + 6 = 0</li>
                        <li>物理：一个物体从10m高处自由下落，求落地时间</li>
                        <li>化学：H2O的分子量是多少</li>
                    </ul>
                `;
                addMessageToChat('ai', { type: 'text', content: response });
            }
        }
        
        // 生成智能回答（基于知识库+逻辑推理）
        function generateIntelligentResponse(content) {
            removeThinkingIndicator();
            // 1. 尝试匹配知识库（优先权威来源）
            let matchedContent = null;
            let matchedTopic = '';
            
            outerLoop:
            for (const [category, subCategories] of Object.entries(knowledgeBase)) {
                for (const [topic, info] of Object.entries(subCategories)) {
                    if (content.includes(topic) || topic.includes(content) || 
                        content.includes(category) || category.includes(content)) {
                        matchedContent = info;
                        matchedTopic = `${category} - ${topic}`;
                        break outerLoop;
                    }
                }
            }
            
            if (matchedContent) {
                // 有匹配结果（标注来源）
                const response = `
                    <p>关于“${matchedTopic}”的信息（来源：内置知识库）：</p>
                    <p class="mt-2">${matchedContent}</p>
                    <p class="mt-3 text-sm text-gray-500">
                        需要我进一步解释或扩展相关内容吗？也可以使用「智能搜索：${matchedTopic}」获取最新信息。
                    </p>
                `;
                addMessageToChat('ai', { type: 'text', content: response });
            } else {
                // 2. 无匹配时建议搜索
                const response = `
                    <p>关于“${content}”，我没有找到足够的权威信息。</p>
                    <p class="mt-2">您可以尝试：</p>
                    <ul class="list-disc list-inside text-sm text-gray-600 mt-1 ml-2 space-y-1">
                        <li>使用「智能搜索：${content}」获取网络信息</li>
                        <li>提供更具体的背景或关键词</li>
                        <li>换一种表达方式提问</li>
                    </ul>
                `;
                addMessageToChat('ai', { type: 'text', content: response });
            }
        }
        
        // 语音通话功能
        function startVoiceCall() {
            if (!canUseFeature()) {
                showNotification('使用次数不足，请登录后继续');
                loginModal.classList.remove('hidden');
                return;
            }
            
            callModal.classList.remove('hidden');
            callStatus.textContent = '正在呼叫...';
            callSeconds = 0;
            clearInterval(callInterval);
            
            // 模拟呼叫过程
            setTimeout(() => {
                callStatus.textContent = '通话中';
                // 开始计时
                callInterval = setInterval(() => {
                    callSeconds++;
                    const minutes = Math.floor(callSeconds / 60).toString().padStart(2, '0');
                    const seconds = (callSeconds % 60).toString().padStart(2, '0');
                    callTimer.textContent = `${minutes}:${seconds}`;
                }, 1000);
                
                decreaseUsageCount(); // 消耗一次使用次数
                showNotification('通话已连接');
            }, 3000);
        }
        
        // 结束通话
        function endVoiceCall() {
            callModal.classList.add('hidden');
            clearInterval(callInterval);
            showNotification(`通话已结束，时长 ${callTimer.textContent}`);
            // 记录通话历史
            addMessageToChat('ai', { 
                type: 'text', 
                content: `语音通话已结束，时长 ${callTimer.textContent}。需要我帮您记录通话要点或继续解答问题吗？` 
            });
        }
        
        // 切换静音状态
        function toggleMute() {
            isMuted = !isMuted;
            muteCallBtn.innerHTML = isMuted ? 
                '<i class="fa fa-microphone-slash"></i>' : 
                '<i class="fa fa-microphone"></i>';
            showNotification(isMuted ? '已静音' : '已取消静音');
        }
        
        // 切换屏幕共享
        function toggleScreenShare() {
            isSharingScreen = !isSharingScreen;
            if (isSharingScreen) {
                // 模拟请求屏幕共享权限
                showNotification('请求屏幕共享权限...');
                setTimeout(() => {
                    shareScreenBtn.innerHTML = '<i class="fa fa-desktop text-red-500"></i>';
                    showNotification('已开始屏幕共享');
                }, 1500);
            } else {
                shareScreenBtn.innerHTML = '<i class="fa fa-desktop"></i>';
                showNotification('已结束屏幕共享');
            }
        }
        
        // 生成音乐
        function generateMusic() {
            const prompt = musicPrompt.value.trim();
            const genre = musicGenre.value;
            
            if (!prompt) {
                showNotification('请输入音乐描述');
                return;
            }
            
            // 显示加载状态
            generateMusicBtn.disabled = true;
            generateMusicBtn.textContent = '生成中...';
            
            // 模拟音乐生成
            setTimeout(() => {
                const genreMap = {
                    'classical': '古典',
                    'pop': '流行',
                    'jazz': '爵士',
                    'electronic': '电子',
                    'piano': '钢琴独奏'
                };
                
                document.getElementById('musicTitle').textContent = prompt;
                document.getElementById('musicInfo').textContent = '2分30秒 · ' + genreMap[genre];
                musicResult.classList.remove('hidden');
                
                // 恢复按钮状态
                generateMusicBtn.disabled = false;
                generateMusicBtn.textContent = '生成音乐';
                
                // 消耗次数并添加到聊天记录
                decreaseUsageCount();
                addMessageToChat('ai', { 
                    type: 'text', 
                    content: `已根据您的需求生成${genreMap[genre]}音乐《${prompt}》，时长2分30秒。您可以在音乐生成面板中播放。` 
                });
                
                showNotification('音乐生成成功');
            }, 3000);
        }
        
        // 生成视频
        function generateVideo() {
            const prompt = videoPrompt.value.trim();
            const duration = videoDuration.value;
            
            if (!prompt) {
                showNotification('请输入视频描述');
                return;
            }
            
            // 显示加载状态
            generateVideoBtn.disabled = true;
            generateVideoBtn.textContent = '生成中...';
            
            // 模拟视频生成
            setTimeout(() => {
                const durationText = duration == 10 ? '10秒' : 
                                    duration == 30 ? '30秒' : 
                                    duration == 60 ? '1分钟' : '2分钟';
                
                document.getElementById('videoInfo').textContent = `${durationText} · 1080p · ${prompt}`;
                videoResult.classList.remove('hidden');
                
                // 恢复按钮状态
                generateVideoBtn.disabled = false;
                generateVideoBtn.textContent = '生成视频';
                
                // 消耗次数并添加到聊天记录
                decreaseUsageCount();
                addMessageToChat('ai', { 
                    type: 'text', 
                    content: `已根据您的需求生成${durationText}视频《${prompt}》，分辨率1080p。您可以在视频生成面板中观看。` 
                });
                
                showNotification('视频生成成功');
            }, 4000);
        }
        
        // 处理数据文件上传
        function handleDataFileUpload() {
            const file = dataFileInput.files[0];
            if (!file) return;
            
            // 检查文件类型
            if (file.type !== 'text/csv' && !file.name.endsWith('.csv')) {
                showNotification('请上传CSV格式的文件');
                dataFileInput.value = '';
                return;
            }
            
            showNotification(`已上传文件：${file.name}`);
            // 这里可以添加文件读取逻辑
        }
        
        // 数据分析
        function analyzeData() {
            if (!dataFileInput.files.length) {
                showNotification('请先上传数据文件');
                return;
            }
            
            // 显示加载状态
            analyzeDataBtn.disabled = true;
            analyzeDataBtn.textContent = '分析中...';
            
            // 模拟数据分析
            setTimeout(() => {
                const type = analysisType.value;
                const typeMap = {
                    'trend': '趋势分析',
                    'distribution': '分布分析',
                    'correlation': '相关性分析',
                    'comparison': '对比分析'
                };
                
                // 生成图表
                const ctx = document.getElementById('analysisChart').getContext('2d');
                new Chart(ctx, {
                    type: type === 'distribution' ? 'doughnut' : 
                          type === 'correlation' ? 'scatter' : 'line',
                    data: {
                        labels: ['1月', '2月', '3月', '4月', '5月', '6月'],
                        datasets: [{
                            label: '数据趋势',
                            data: [12, 19, 25, 15, 20, 28],
                            borderColor: '#3B82F6',
                            backgroundColor: type === 'distribution' ? 
                                ['#3B82F6', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6', '#06B6D4'] : 
                                'rgba(59, 130, 246, 0.1)',
                            tension: 0.3,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: `${typeMap[type]}结果`
                            }
                        }
                    }
                });
                
                dataAnalysisResult.classList.remove('hidden');
                
                // 恢复按钮状态
                analyzeDataBtn.disabled = false;
                analyzeDataBtn.textContent = '开始分析';
                
                // 消耗次数并添加到聊天记录
                decreaseUsageCount();
                addMessageToChat('ai', { 
                    type: 'text', 
                    content: `已完成${typeMap[type]}，分析显示数据呈现稳步增长趋势，其中3月和6月达到峰值，平均增长率为8.2%。详细结果可在数据分析面板查看。` 
                });
                
                showNotification('数据分析完成');
            }, 3500);
        }
        
        // 添加消息到聊天界面
        function addMessageToChat(role, message) {
            // 保存到历史记录
            chatHistory[currentChatId].push({
                role,
                ...message,
                timestamp: new Date().toISOString()
            });
            saveToLocalStorage();
            updateHistoryList();
            
            let messageHtml = '';
            
            if (role === 'user') {
                messageHtml = `
                    <div class="flex items-start gap-3 justify-end">
                        <div class="message-card bg-primary/10">
                            ${message.type === 'text' ? 
                                `<p>${message.content}</p>` : 
                                `<img src="${message.content}" alt="用户上传的图片" class="w-full h-auto rounded-lg">`
                            }
                            <div class="mt-2 flex gap-1 justify-end">
                                <button class="text-xs p-1 text-gray-500 hover:text-primary" title="收藏">
                                    <i class="fa fa-star-o"></i>
                                </button>
                                <button class="text-xs p-1 text-gray-500 hover:text-primary" title="转发">
                                    <i class="fa fa-share-alt"></i>
                                </button>
                            </div>
                        </div>
                        <div class="w-10 h-10 rounded-full bg-gray-200 flex items-center justify-center flex-shrink-0">
                            <i class="fa fa-user text-gray-600"></i>
                        </div>
                    </div>
                `;
            } else {
                messageHtml = `
                    <div class="flex items-start gap-3">
                        <div class="ai-avatar flex-shrink-0"></div>
                        <div class="message-card bg-white">
                            ${message.content}
                            <div class="mt-2 flex gap-1 justify-end">
                                <button class="text-xs p-1 text-gray-500 hover:text-primary" title="收藏">
                                    <i class="fa fa-star-o"></i>
                                </button>
                                <button class="text-xs p-1 text-gray-500 hover:text-primary" title="转发">
                                    <i class="fa fa-share-alt"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            chatContainer.insertAdjacentHTML('beforeend', messageHtml);
            scrollToBottom();
            
            // 绑定收藏和转发按钮事件
            bindMessageActions();
        }
        
        // 绑定消息的收藏和转发功能
        function bindMessageActions() {
            const favoriteButtons = chatContainer.querySelectorAll('.fa-star-o').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    this.classList.toggle('fa-star-o');
                    this.classList.toggle('fa-star');
                    this.classList.toggle('text-yellow-400');
                    
                    // 收藏逻辑
                    const messageText = this.closest('.message-card').querySelector('p').textContent;
                    const isFavorite = this.classList.contains('fa-star');
                    
                    if (isFavorite) {
                        favorites.push({
                            id: 'fav-' + Date.now(),
                            text: messageText.substring(0, 50) + (messageText.length > 50 ? '...' : ''),
                            chatId: currentChatId,
                            timestamp: new Date().toISOString()
                        });
                        showNotification('已收藏该消息');
                    } else {
                        // 取消收藏
                        const index = favorites.findIndex(fav => fav.text === messageText.substring(0, 50));
                        if (index > -1) favorites.splice(index, 1);
                        showNotification('已取消收藏');
                    }
                    
                    saveToLocalStorage();
                    updateFavorites();
                });
            });
            
            const shareButtons = chatContainer.querySelectorAll('.fa-share-alt').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const messageText = this.closest('.message-card').querySelector('p').textContent;
                    // 模拟转发功能
                    navigator.clipboard.writeText(messageText).then(() => {
                        showNotification('消息已复制到剪贴板，可粘贴转发');
                    });
                });
            });
        }
        
        // 更新收藏列表
        function updateFavorites() {
            const favoritesSection = document.getElementById('favoritesSection');
            if (favorites.length === 0) {
                favoritesSection.innerHTML = `
                    <p class="text-sm text-gray-500 mb-3">您还没有收藏任何对话</p>
                    <div class="text-center py-6">
                        <i class="fa fa-star-o text-4xl text-gray-300 mb-2"></i>
                        <p class="text-sm text-gray-400">收藏重要对话以便日后查看</p>
                    </div>
                `;
                return;
            }
            
            let favoritesHtml = '<div class="space-y-3">';
            favorites.forEach(fav => {
                const date = new Date(fav.timestamp);
                const timeString = `${date.getMonth()+1}月${date.getDate()}日 ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
                
                favoritesHtml += `
                    <div class="p-3 bg-light rounded-lg hover:bg-gray-100 transition-colors">
                        <p class="text-sm">${fav.text}</p>
                        <p class="text-xs text-gray-500 mt-1">${timeString}</p>
                        <div class="mt-2 flex justify-end">
                            <button class="text-xs text-red-500 hover:underline" data-favid="${fav.id}">取消收藏</button>
                        </div>
                    </div>
                `;
            });
            favoritesHtml += '</div>';
            favoritesSection.innerHTML = favoritesHtml;
            
            // 绑定取消收藏事件
            document.querySelectorAll('[data-favid]').forEach(btn => {
                btn.addEventListener('click', function() {
                    const favId = this.dataset.favid;
                    favorites = favorites.filter(fav => fav.id !== favId);
                    saveToLocalStorage();
                    updateFavorites();
                    showNotification('已取消收藏');
                });
            });
        }
        
        // 移除思考指示器
        function removeThinkingIndicator() {
            const thinkingEl = document.getElementById('thinkingIndicator');
            if (thinkingEl) thinkingEl.remove();
        }
        
        // 创建新对话
        function createNewChat() {
            currentChatId = 'chat-' + Date.now();
            chatHistory[currentChatId] = [];
            chatContainer.innerHTML = `
                <div class="flex items-start gap-3">
                    <div class="ai-avatar flex-shrink-0"></div>
                    <div class="message-card bg-white">
                        <p>您好！我是 see AI 全能助手，可为您提供以下服务：</p>
                        <ul class="list-disc list-inside text-sm mt-2 ml-2 space-y-1">
                            <li>智能问答、解题答疑（数学/物理等学科）</li>
                            <li>语音通话、屏幕共享</li>
                            <li>音乐生成、视频制作</li>
                            <li>数据分析、图表生成</li>
                        </ul>
                        ${!currentUser ? '<p class="text-xs text-gray-500 mt-2">未登录用户可免费使用10次，登录后无限制</p>' : ''}
                    </div>
                </div>
            `;
            saveToLocalStorage();
            updateHistoryList();
            messageInput.value = '';
        }
        
        // 更新历史对话列表
        function updateHistoryList() {
            historyList.innerHTML = '';
            
            // 按时间倒序排列对话
            const sortedChatIds = Object.keys(chatHistory).sort((a, b) => 
                new Date(b.split('-')[1]) - new Date(a.split('-')[1])
            );
            
            sortedChatIds.forEach(chatId => {
                const chat = chatHistory[chatId];
                if (chat.length === 0) return;
                
                // 获取最后一条消息作为预览
                const lastMessage = chat[chat.length - 1];
                const previewText = lastMessage.type === 'text' 
                    ? lastMessage.content.substring(0, 20) + (lastMessage.content.length > 20 ? '...' : '')
                    : (lastMessage.role === 'user' ? '上传了一张图片' : '回复了图片内容');
                
                // 格式化时间
                const date = new Date(chatId.split('-')[1]);
                const timeString = `${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
                
                const historyItem = document.createElement('div');
                historyItem.className = `history-item p-3 rounded-lg hover:bg-light cursor-pointer ${chatId === currentChatId ? 'bg-light/50 border-l-2 border-primary' : ''}`;
                historyItem.innerHTML = `
                    <p class="text-sm font-medium truncate">${previewText}</p>
                    <p class="text-xs text-gray-500 truncate mt-1">${timeString}</p>
                `;
                
                historyItem.addEventListener('click', () => {
                    switchToChat(chatId);
                });
                
                historyList.appendChild(historyItem);
            });
        }
        
        // 切换到指定对话
        function switchToChat(chatId) {
            currentChatId = chatId;
            renderChat();
            updateHistoryList();
            
            // 在移动设备上切换对话后隐藏历史面板
            if (window.innerWidth < 768) {
                historyPanel.classList.add('hidden');
                historyPanel.classList.remove('flex');
            }
        }
        
        // 渲染当前对话
        function renderChat() {
            chatContainer.innerHTML = '';
            const chat = chatHistory[currentChatId] || [];
            
            if (chat.length === 0) {
                chatContainer.innerHTML = `
                    <div class="flex items-start gap-3">
                        <div class="ai-avatar flex-shrink-0"></div>
                        <div class="message-card bg-white">
                            <p>您好！我是 see AI 全能助手，可为您提供以下服务：</p>
                            <ul class="list-disc list-inside text-sm mt-2 ml-2 space-y-1">
                                <li>智能问答、解题答疑（数学/物理等学科）</li>
                                <li>语音通话、屏幕共享</li>
                                <li>音乐生成、视频制作</li>
                                <li>数据分析、图表生成</li>
                            </ul>
                            ${!currentUser ? '<p class="text-xs text-gray-500 mt-2">未登录用户可免费使用10次，登录后无限制</p>' : ''}
                        </div>
                    </div>
                `;
                return;
            }
            
            chat.forEach(message => {
                let messageHtml = '';
                
                if (message.role === 'user') {
                    messageHtml = `
                        <div class="flex items-start gap-3 justify-end">
                            <div class="message-card bg-primary/10">
                                ${message.type === 'text' ? 
                                    `<p>${message.content}</p>` : 
                                    `<img src="${message.content}" alt="用户上传的图片" class="w-full h-auto rounded-lg">`
                                }
                                <div class="mt-2 flex gap-1 justify-end">
                                    <button class="text-xs p-1 text-gray-500 hover:text-primary" title="收藏">
                                        <i class="fa fa-star-o"></i>
                                    </button>
                                    <button class="text-xs p-1 text-gray-500 hover:text-primary" title="转发">
                                        <i class="fa fa-share-alt"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="w-10 h-10 rounded-full bg-gray-200 flex items-center justify-center flex-shrink-0">
                                <i class="fa fa-user text-gray-600"></i>
                            </div>
                        </div>
                    `;
                } else {
                    messageHtml = `
                        <div class="flex items-start gap-3">
                            <div class="ai-avatar flex-shrink-0"></div>
                            <div class="message-card bg-white">
                                ${message.content}
                                <div class="mt-2 flex gap-1 justify-end">
                                    <button class="text-xs p-1 text-gray-500 hover:text-primary" title="收藏">
                                        <i class="fa fa-star-o"></i>
                                    </button>
                                    <button class="text-xs p-1 text-gray-500 hover:text-primary" title="转发">
                                        <i class="fa fa-share-alt"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                chatContainer.insertAdjacentHTML('beforeend', messageHtml);
            });
            
            scrollToBottom();
            bindMessageActions();
        }
        
        // 滚动到底部
        function scrollToBottom() {
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }
        
        // 显示通知
        function showNotification(message) {
            // 创建通知元素
            const notification = document.createElement('div');
            notification.className = 'fixed bottom-4 right-4 bg-dark text-white px-4 py-2 rounded-lg shadow-lg z-50 transform translate-y-10 opacity-0 transition-all duration-300';
            notification.textContent = message;
            document.body.appendChild(notification);
            
            // 显示通知
            setTimeout(() => {
                notification.classList.remove('translate-y-10', 'opacity-0');
            }, 10);
            
            // 3秒后隐藏通知
            setTimeout(() => {
                notification.classList.add('translate-y-10', 'opacity-0');
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }
        
        // 保存到本地存储
        function saveToLocalStorage() {
            localStorage.setItem('seeAiChatHistory', JSON.stringify(chatHistory));
            localStorage.setItem('seeAiFavorites', JSON.stringify(favorites));
            if (!currentUser) {
                localStorage.setItem('seeAiGuestUsage', guestUsageCount);
            }
        }
        
        // 从本地存储加载
        function loadFromLocalStorage() {
            const savedHistory = localStorage.getItem('seeAiChatHistory');
            const savedFavorites = localStorage.getItem('seeAiFavorites');
            
            if (savedHistory) {
                chatHistory = JSON.parse(savedHistory);
            }
            
            if (savedFavorites) {
                favorites = JSON.parse(savedFavorites);
                updateFavorites();
            }
            
            updateHistoryList();
        }
        
        // 初始化应用
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
